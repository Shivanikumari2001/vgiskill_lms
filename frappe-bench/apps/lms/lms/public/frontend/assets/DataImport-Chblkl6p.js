import{A as ce,aa as Z,d as ee,y as E,B as L,J as te,a as p,e,f as I,w as A,p as W,Q as pe,F as Q,g as X,h as j,b as z,f5 as xe,l as Y,W as K,t as D,u as q,bw as we,a3 as re,eY as Se,q as fe,o as a,n as G,z as ve,az as le,aQ as $e,f6 as Ce,am as me,bL as Ie,s as Me,v as Fe,c as _e,f7 as Ve,bU as ye,bV as Ee,eO as Te,O as De,f8 as Ne,H as Ue,aA as be,x as Re,i as Le,E as Oe}from"./index-C4szjxrb.js";import{_ as je}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-Bd-WFY5M.js";import{T as Pe}from"./TabButtons-1rgcL6JH.js";const ie=h=>({Pending:"orange",Success:"green","Partial Success":"orange",Error:"red","Timed Out":"orange"})[h]||"gray",ne=["Section Break","Column Break","Tab Break","HTML","Table","Table MultiSelect","Button","Image","Fold","Heading"],he=(h,T,d)=>{let s="";return d.filter(f=>f.name==T)[0].fields.forEach(f=>{f.options==h&&(s=f.fieldname)}),s},ke=(h,T,d)=>ce("frappe.core.doctype.data_import.data_import.get_preview_from_template",{data_import:h,import_file:T,google_sheets_url:d}).catch(s=>{var n;Z.error(((n=s.messages)==null?void 0:n[0])||s),console.error("Error fetching preview data:",s)}),ze={class:"flex min-h-0 flex-col text-base py-5 w-[90%] lg:w-[700px] mx-auto"},Be={class:"flex items-center justify-between"},qe={class:"flex items-center space-x-2 my-5"},Ae={key:0,class:"overflow-y-scroll"},Je={class:"divide-y"},He=["onClick"],Ge={class:"space-y-1"},We={class:"text-ink-gray-7"},Ke={class:"text-ink-gray-5"},Qe={class:"my-5 flex justify-center"},Ye={key:1,class:"text-sm italic text-ink-gray-5 mt-5"},Xe=ee({__name:"DataImportList",props:{dataImports:{}},emits:["updateStep"],setup(h,{emit:T}){const d=E(""),s=E("All"),n=E(!1),f=E(null),u=fe(),v=h,N=L(()=>["All","Pending","Success","Partial Success","Error","Timed Out"].map(l=>({label:l,value:l})));te([d,s],([g,l])=>{v.dataImports.update({filters:[g?[["name","like",`%${g}%`]]:[],l!=="All"?[["status","=",l]]:[]].flat()}),v.dataImports.reload()});const R=g=>{v.dataImports.insert.submit({reference_doctype:f.value,import_type:"Insert New Records",mute_emails:!0,status:"Pending"},{onSuccess(l){u.replace({name:"DataImport",params:{importName:l.name}}),g()},onError(l){var m;console.error(l),Z.error(((m=l.messages)==null?void 0:m[0])||l)}})},B=g=>{u.replace({name:"DataImport",params:{importName:g}})};return(g,l)=>{var m;return a(),p("div",ze,[e("div",Be,[l[7]||(l[7]=e("div",null,[e("div",{class:"text-xl font-semibold mb-1 text-ink-gray-9"}," Data Import "),e("div",{class:"text-ink-gray-6 leading-5"}," Import data into your system using CSV files. ")],-1)),I(W,{variant:"solid",onClick:l[0]||(l[0]=i=>n.value=!0)},{prefix:A(()=>[I(K,{name:"plus",class:"size-4 stroke-1.5"})]),default:A(()=>[l[6]||(l[6]=Y(" Import ",-1))]),_:1})]),e("div",qe,[I(pe,{modelValue:d.value,"onUpdate:modelValue":l[1]||(l[1]=i=>d.value=i),placeholder:"Search imported files",type:"text",class:"flex-1"},null,8,["modelValue"]),I(pe,{modelValue:s.value,"onUpdate:modelValue":l[2]||(l[2]=i=>s.value=i),type:"select",options:N.value},null,8,["modelValue","options"])]),(m=h.dataImports.data)!=null&&m.length?(a(),p("div",Ae,[e("div",Je,[l[8]||(l[8]=e("div",{class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center text-sm text-ink-gray-5 py-1.5 mx-2 my-0.5 px-1"},[e("div",null," Name "),e("div",{class:"pl-1"}," Status ")],-1)),(a(!0),p(Q,null,X(h.dataImports.data,i=>(a(),p("div",{onClick:()=>B(i.name),class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center cursor-pointer py-2.5 px-1 mx-2"},[e("div",Ge,[e("div",We,D(i.reference_doctype),1),e("div",Ke,D(q(we)(i.creation).fromNow()),1)]),I(re,{label:i.status,theme:q(ie)(i.status),class:"w-fit"},null,8,["label","theme"])],8,He))),256))]),e("div",Qe,[v.dataImports.hasNextPage?(a(),j(W,{key:0,onClick:l[3]||(l[3]=i=>v.dataImports.next())},{prefix:A(()=>[I(K,{name:"refresh-cw",class:"size-4 stroke-1.5"})]),default:A(()=>[l[9]||(l[9]=Y(" Load More ",-1))]),_:1})):z("",!0)])])):(a(),p("div",Ye," No data imports found. ")),I(xe,{modelValue:n.value,"onUpdate:modelValue":l[5]||(l[5]=i=>n.value=i),options:{title:"New Data Import",actions:[{label:"Continue",variant:"solid",onClick({close:i}){R(i)}}]}},{"body-content":A(()=>[e("div",null,[I(Se,{modelValue:f.value,"onUpdate:modelValue":l[4]||(l[4]=i=>f.value=i),doctype:"DocType",filters:{allow_import:1},label:"Choose a Document Type to import"},null,8,["modelValue"])])]),_:1},8,["modelValue","options"])])}}}),Ze={class:"flex items-center space-x-3 lg:space-x-10 text-xs lg:text-base"},ge=ee({__name:"ImportSteps",props:{data:{},step:{}},emits:["updateStep"],setup(h,{emit:T}){const d=T,s=h,n=L(()=>s.step==="upload"),f=L(()=>{var l,m;return((l=s.data)==null?void 0:l.import_file)||((m=s.data)==null?void 0:m.google_sheets_url)}),u=L(()=>s.step==="map"),v=L(()=>{var l;return s.data&&((l=s.data)==null?void 0:l.template_options)&&JSON.parse(s.data.template_options).column_to_field_map}),N=L(()=>s.step==="preview"),R=L(()=>{var l;return((l=s.data)==null?void 0:l.status)==="Success"}),B=()=>{f.value&&d("updateStep","map",{...s.data})},g=()=>{f.value&&d("updateStep","preview",{...s.data})};return(l,m)=>(a(),p("div",Ze,[e("div",{class:G(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5 cursor-pointer",{"text-ink-gray-9 font-semibold":n.value}]),onClick:m[0]||(m[0]=i=>d("updateStep","upload",{...h.data}))},[f.value?(a(),j(K,{key:0,name:"check",class:G(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":n.value}])},null,8,["class"])):(a(),p("div",{key:1,class:G(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":n.value}])},[...m[3]||(m[3]=[e("span",null," 1 ",-1)])],2)),m[4]||(m[4]=e("div",null," Upload File ",-1))],2),e("div",{class:G(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":u.value,"cursor-pointer":f.value}]),onClick:m[1]||(m[1]=i=>B())},[v.value?(a(),j(K,{key:0,name:"check",class:G(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":u.value}])},null,8,["class"])):(a(),p("div",{key:1,class:G(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":u.value}])},[...m[5]||(m[5]=[e("span",null," 2 ",-1)])],2)),m[6]||(m[6]=e("div",null," Map Data ",-1))],2),e("div",{class:G(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":N.value,"cursor-pointer":f.value}]),onClick:m[2]||(m[2]=i=>g())},[R.value?(a(),j(K,{key:0,name:"check",class:G(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":N.value}])},null,8,["class"])):(a(),p("div",{key:1,class:G(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":N.value}])},[...m[7]||(m[7]=[e("span",null," 3 ",-1)])],2)),m[8]||(m[8]=e("div",null," Review & Import ",-1))],2)]))}}),et={class:"w-[85%] lg:w-[700px] mx-auto py-12 space-y-8"},tt={class:"flex justify-between"},at={class:"space-y-2"},st={class:"text-lg font-semibold text-ink-gray-9"},lt={class:"flex flex-col lg:flex-row space-y-2 lg:space-x-2 lg:space-y-0"},ot={key:0,class:"border rounded-md space-y-8"},nt={class:"grid grid-cols-2 py-2 px-4 gap-y-8"},rt={class:"text-ink-gray-7"},it=ee({__name:"MappingStep",props:{dataImports:{},data:{},fields:{}},emits:["updateStep"],setup(h,{emit:T}){const d=E(null),s=T,n=E({}),f=E(!1),u=h;ve(async()=>{d.value=await ke(u.data.name,u.data.import_file,u.data.google_sheets_url),v()});const v=()=>{var F,C,M;const i={};let t=[];(F=u.data)!=null&&F.template_options&&(t=(M=JSON.parse((C=u.data)==null?void 0:C.template_options))==null?void 0:M.column_to_field_map),Object.keys(t).length>0&&(f.value=!0),B.value.forEach((c,o)=>{t&&t[o]?i[c]=N(t[o]):i[c]=c}),n.value=i},N=i=>{const t=g.value.find(F=>F.value==i);return t?t.label:i},R=(i,t)=>{var M,c;if(!t)return;f.value=!0;let F=(M=u.data)!=null&&M.template_options?JSON.parse((c=u.data)==null?void 0:c.template_options):{},C=F.column_to_field_map||{};C[i-1]=t.value,u.dataImports.setValue.submit({...u.data,template_options:JSON.stringify({...F,column_to_field_map:C})},{onSuccess:o=>{s("updateStep","map",{...o}),le(()=>{v()})},onError:o=>{var k;Z.error(((k=o.messages)==null?void 0:k[0])||o),console.error("Error updating column mappings:",o)}})},B=L(()=>{var t;const i=[];return(t=d.value)==null||t.columns.forEach(F=>{F.header_title!="Sr. No"&&i.push(F.header_title)}),i}),g=L(()=>{var F;const i=u.data.reference_doctype;return(((F=u.fields.data)==null?void 0:F.docs)||[]).map(C=>{const M=C.name===i,c=C.fields.filter(o=>!ne.includes(o.fieldtype)).map(o=>({value:o.fieldname,label:M?o.label:`${o.label} (${m(i,C.name)})`}));return[{value:"name",label:"ID"},...c]}).flat()}),l=()=>{var t,F;let i=(t=u.data)!=null&&t.template_options?JSON.parse((F=u.data)==null?void 0:F.template_options):{};u.dataImports.setValue.submit({...u.data,template_options:JSON.stringify({...i,column_to_field_map:{}})},{onSuccess:C=>{s("updateStep","map",{...C}),le(()=>{v()})},onError:C=>{var M;Z.error(((M=C.messages)==null?void 0:M[0])||C),console.error("Error resetting column mappings:",C)}})},m=(i,t)=>{var M,c;let C=(((c=(M=u.fields.data)==null?void 0:M.docs.find(o=>o.name==i))==null?void 0:c.fields)||[]).filter(o=>o.options==t)[0];return(C==null?void 0:C.label)||t};return(i,t)=>{var F,C;return a(),p("div",et,[e("div",tt,[e("div",at,[e("div",st,[t[1]||(t[1]=e("span",null," Map Data ",-1)),(F=h.data)!=null&&F.status?(a(),j(re,{key:0,theme:q(ie)((C=h.data)==null?void 0:C.status)},{default:A(()=>{var M;return[Y(D((M=h.data)==null?void 0:M.status),1)]}),_:1},8,["theme"])):z("",!0)]),t[2]||(t[2]=e("div",{class:"leading-5"}," Change the mapping of columns from your file to fields in the system ",-1))]),e("div",lt,[f.value?(a(),j(W,{key:0,label:"Reset Mapping",onClick:l})):z("",!0),I(W,{label:"Continue",variant:"solid",onClick:t[0]||(t[0]=M=>i.$emit("updateStep","preview"))})])]),Object.keys(n.value).length?(a(),p("div",ot,[t[3]||(t[3]=e("div",{class:"grid grid-cols-2 text-ink-gray-5 border-b py-2 px-4"},[e("div",null," Fields in File "),e("div",null," Fields in System ")],-1)),e("div",nt,[(a(!0),p(Q,null,X(B.value.length,M=>(a(),p(Q,{key:M},[e("div",rt,D(B.value[M-1]),1),I($e,{"model-value":n.value[B.value[M-1]],options:g.value,placeholder:"Select field","onUpdate:modelValue":c=>R(M,c)},null,8,["model-value","options","onUpdate:modelValue"])],64))),128))])])):z("",!0)])}}}),dt={class:"text-base h-full flex flex-col w-[90%] lg:w-[700px] mx-auto py-12 space-y-10"},ut={class:"flex flex-col space-y-1"},ct={class:"flex items-center justify-between text-ink-gray-7"},pt={class:"flex items-center space-x-2 text-lg font-semibold text-ink-gray-9"},mt={key:0,class:"space-y-2"},ft={class:"border rounded-md bg-surface-gray-2 p-4 space-y-4 text-sm"},vt={class:"grid grid-cols-[40%,10%,40%] lg:grid-cols-3 space-x-3 items-center"},yt={class:""},gt={class:"flex justify-end"},xt={key:1,class:"border rounded-md overflow-x-auto"},_t={class:"divide-y"},bt={class:"rounded-t-md"},ht={class:"bg-surface-white divide-y divide-surface-gray-2"},kt={class:"leading-5 text-sm"},wt={key:2,class:"space-y-4"},St={key:0,class:"border rounded-md overflow-x-auto"},$t={class:"table-fixed w-full divide-y"},Ct={class:"bg-surface-white divide-y divide-surface-gray-2"},It={class:"px-3 py-2 text-sm text-ink-gray-7 border-r"},Mt={class:"flex items-center justify-center space-x-2"},Ft={key:0,class:"size-1.5 bg-surface-green-3 rounded"},Vt={key:1,class:"size-1.5 bg-surface-red-5 rounded"},Et={class:"px-3 py-2 text-sm text-ink-gray-7 w-full"},Tt=["innerHTML"],Dt={key:1},Nt={key:2},Ut=["onClick"],Rt={class:"px-3 py-2 text-ink-gray-5 float-right invisible group-hover:visible"},Lt={class:"w-[500px] p-2 text-xs leading-5 font-mono"},Ot={key:1,class:"text-ink-gray-5 text-sm"},jt=ee({__name:"PreviewStep",props:{dataImports:{},data:{},fields:{},doctypeMap:{}},emits:["updateStep"],setup(h,{emit:T}){const d=E(null),s=T,n=E([]),f=E([]),u=E("all"),v=h;ve(async()=>{var x;Ce().on("data_import_refresh",S=>{N(S.data_import)}),(x=v.data)!=null&&x.name&&(d.value=await ke(v.data.name,v.data.import_file,v.data.google_sheets_url),v.data.status!="Pending"&&i())});const N=y=>{y==v.data.name&&le(()=>{v.dataImports.reload(),le(async()=>{var S;let x=(S=v.dataImports.data)==null?void 0:S.find(J=>J.name===v.data.name);s("updateStep","preview",{...x}),i()})})},R=L(()=>{var x;const y=[];return(x=d.value)==null||x.columns.forEach((S,J)=>{let _="left",P="300px";J==0?(S.header_title="No",_="center",P="60px"):S.header_title=="ID"&&(P="150px"),y.push({key:S.header_title,label:S.header_title,width:P,align:_})}),y}),B=L(()=>{var x;const y=[];return(x=d.value)==null||x.data.forEach(S=>{const J={};Object.keys(S).forEach((_,P)=>{let O=g(P),b=l(P);O=="No"?J[O]=S[_]-1:b?J[O]=S[b]:J[O]=S[_]}),y.push(J)}),y}),g=y=>{var x,S;return((S=(x=d.value)==null?void 0:x.columns[y])==null?void 0:S.header_title)||`Column ${y+1}`},l=y=>{var _,P,O,b,r,V,$;if(!((P=(_=d.value)==null?void 0:_.columns[y])==null?void 0:P.map_to_field))return null;let S=(r=(b=(O=d.value)==null?void 0:O.columns[y])==null?void 0:b.df)==null?void 0:r.label;return($=(V=d.value)==null?void 0:V.columns.filter(U=>U.header_title==S)[0])==null?void 0:$.column_number},m=()=>{ce("frappe.core.doctype.data_import.data_import.form_start_import",{data_import:v.data.name})},i=()=>{ce("frappe.core.doctype.data_import.data_import.get_import_logs",{data_import:v.data.name}).then(y=>{n.value=y,f.value=y})},t=()=>{u.value=="all"?f.value=n.value:u.value=="successful"?f.value=n.value.filter(y=>y.success):u.value=="failed"&&(f.value=n.value.filter(y=>!y.success))};te(u,()=>{t()});const F=L(()=>n.value.length?n.value.filter(y=>y.success).length:0),C=L(()=>n.value.length?n.value.filter(y=>!y.success).length:0),M=L(()=>C.value==0?"bg-surface-green-2 text-ink-green-3":F.value==0?"bg-surface-red-2 text-ink-red-3":"bg-surface-amber-2 text-ink-amber-3"),c=L(()=>{var x,S;let y=[];return(S=(x=d.value)==null?void 0:x.warnings)!=null&&S.length?(d.value.warnings.forEach(J=>{const _=/<strong>(.*?)<\/strong>/g;let P;const O=[];for(;(P=_.exec(J.message))!==null;)O.push(P[1]);y.push(O)}),y):[]}),o=L(()=>{var y;return(y=v.doctypeMap[v.data.reference_doctype])==null?void 0:y.listRoute}),k=()=>{o.value&&(window.location.href=o.value)},w=L(()=>{var y;return(y=v.doctypeMap[v.data.reference_doctype])==null?void 0:y.pageRoute}),ae=y=>{w.value&&(window.location.href=w.value.replace("docname",y))},de=L(()=>[{label:"All",value:"all"},{label:"Successful",value:"successful"},{label:"Failed",value:"failed"}]),se=y=>{var x,S;return(S=(x=JSON.parse(y.messages))==null?void 0:x[0])==null?void 0:S.message};return(y,x)=>{var S,J;return a(),p("div",dt,[e("div",ut,[e("div",ct,[e("div",pt,[x[2]||(x[2]=e("span",null," Review and Import ",-1)),I(re,{theme:q(ie)(h.data.status)},{default:A(()=>[Y(D(h.data.status),1)]),_:1},8,["theme"])]),h.data.status!="Success"?(a(),j(W,{key:0,label:h.data.status!="Pending"?"Retry":"Import",variant:"solid",onClick:m},null,8,["label"])):o.value?(a(),j(W,{key:1,label:"Done",onClick:x[0]||(x[0]=_=>k())})):z("",!0)]),x[3]||(x[3]=e("div",{class:"leading-5"}," Verify the data before starting the import process ",-1))]),c.value.length?(a(),p("div",mt,[x[4]||(x[4]=e("div",{class:"text-ink-gray-5 text-sm"}," Column Mapping ",-1)),e("div",ft,[(a(!0),p(Q,null,X(c.value,_=>(a(),p("div",vt,[e("div",yt,D(_[0]),1),e("div",gt,[I(K,{name:"arrow-right",class:"inline size-4 text-ink-gray-5"})]),e("div",null,D(_[1]),1)]))),256))])])):z("",!0),(J=(S=d.value)==null?void 0:S.data)!=null&&J.length?(a(),p("div",xt,[e("table",_t,[e("thead",bt,[e("tr",null,[(a(!0),p(Q,null,X(R.value,_=>(a(),p("th",{key:_.key,style:me({minWidth:_.width,textAlign:_.align}),class:G(["p-2 text-left text-sm text-ink-gray-5",{"border-r":_.key!=R.value[R.value.length-1].key,"w-full":_.key==R.value[R.value.length-1].key}])},D(_.label),7))),128))])]),e("tbody",ht,[(a(!0),p(Q,null,X(B.value,(_,P)=>(a(),p("tr",{key:P},[(a(!0),p(Q,null,X(R.value,O=>(a(),p("td",{key:O.key,style:me({minWidth:O.width,textAlign:O.align}),class:G(["px-3 py-2 text-sm text-ink-gray-7 align-top",{"border-r":O.key!=R.value[R.value.length-1].key}])},[e("div",kt,D(_[O.key]),1)],6))),128))]))),128))])])])):z("",!0),h.data.status!="Pending"&&n.value.length?(a(),p("div",wt,[x[7]||(x[7]=e("div",{class:"font-semibold text-ink-gray-9"}," Import Logs ",-1)),e("div",{class:G(["rounded-md p-2",M.value])},D(F.value)+" "+D(F.value==1?"row":"rows")+" imported successfully, "+D(C.value)+" "+D(C.value==1?"row":"rows")+" failed. ",3),I(Pe,{buttons:de.value,modelValue:u.value,"onUpdate:modelValue":x[1]||(x[1]=_=>u.value=_),class:"w-fit"},null,8,["buttons","modelValue"]),f.value.length?(a(),p("div",St,[e("table",$t,[x[6]||(x[6]=e("thead",{class:"rounded-t-md"},[e("tr",null,[e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-20 border-r text-center"}," Row no. "),e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-[80%]"}," Message ")])],-1)),e("tbody",Ct,[(a(!0),p(Q,null,X(f.value,(_,P)=>(a(),p("tr",{key:P,class:"group"},[e("td",It,[e("div",Mt,[_.success?(a(),p("div",Ft)):(a(),p("div",Vt)),e("div",null,D(JSON.parse(_.row_indexes)[0]-1),1)])]),e("td",Et,[se(_)?(a(),p("span",{key:0,innerHTML:se(_)},null,8,Tt)):!se(_)&&!_.success?(a(),p("span",Dt," Failed to import ")):_.success?(a(),p("span",Nt,[x[5]||(x[5]=Y(" Successfully imported ",-1)),e("span",{onClick:O=>ae(_.docname),class:G({"cursor-pointer underline":w.value})},D(_.docname),11,Ut)])):z("",!0)]),e("td",Rt,[_.exception?(a(),j(Ie,{key:0,trigger:"hover",placement:"left-start"},{target:A(()=>[I(K,{name:"info",class:"size-4"})]),"body-main":A(()=>[e("div",Lt,D(_.exception),1)]),_:2},1024)):z("",!0)])]))),128))])])])):(a(),p("div",Ot," No logs to display. "))])):z("",!0)])}}}),Pt={class:"text-base space-y-5"},zt={class:"grid grid-cols-2 gap-5"},Bt={class:"border-t"},qt={class:"space-x-2 mt-2 mb-5"},At={class:"space-y-8"},Jt={class:"text-ink-gray-5"},Ht={class:"grid grid-cols-2 gap-5"},Gt=["for"],Wt={class:"flex justify-end space-x-2"},Kt=ee({__name:"TemplateModal",props:Me({doctype:{}},{modelValue:{type:Boolean,required:!0,default:!1},modelModifiers:{}}),emits:["update:modelValue"],setup(h){const T=Fe(h,"modelValue"),d=E("CSV"),s=E("Blank Template"),n=E({}),f=E(null),u=h,v=_e({url:"frappe.desk.form.load.getdoctype",params:{doctype:u.doctype,with_parent:1},auto:!0,transform(c){return f.value=c.docs,N(c)}}),N=c=>{let o={};return R(c.docs,o),B(o),g(o),o},R=(c,o)=>{c.forEach(k=>{o[k.name]=k.fields.filter(w=>!ne.includes(w.fieldtype)).map(w=>({fieldname:w.fieldname,label:w.label,reqd:w.reqd,disabled:!!(k.name==u.doctype&&w.reqd)}))})},B=c=>{Object.keys(c).forEach(o=>{c[o].unshift({fieldname:"name",label:"ID",reqd:1})})},g=c=>{Object.keys(c).forEach(o=>{n.value[o]||(n.value[o]={},o==u.doctype&&c[o].forEach(k=>{k.reqd&&(n.value[o][k.fieldname]=!0)}))})},l=()=>{let c=u.doctype,o=i(),k=t(),w=s.value=="5 Records"?5:"";return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(c)}
        &export_fields=${encodeURIComponent(JSON.stringify(o))}
        &export_records=${encodeURIComponent(k)}
        &file_type=${encodeURIComponent(d.value)}
        &export_page_length=${w}`.replace(/\s+/g,"")},m=async()=>{let c=l();const k=await(await fetch(c)).blob(),w=document.createElement("a");w.href=URL.createObjectURL(k),w.download=u.doctype+(d.value==="CSV"?".csv":".xlsx"),document.body.appendChild(w),w.click(),document.body.removeChild(w)},i=()=>{let c={};return Object.keys(n.value).forEach(o=>{let k=o==u.doctype?o:he(o,u.doctype,f.value);c[k]=Object.keys(n.value[o]).filter(w=>n.value[o][w])}),c},t=()=>s.value=="Blank Template"?"blank_template":s.value=="5 Records"?"5_records":"all",F=()=>{Object.keys(v.data).forEach(c=>{v.data[c].forEach(o=>{n.value[c]||(n.value[c]={}),n.value[c][o.fieldname]=!0})})},C=()=>{Object.keys(v.data).forEach(c=>{v.data[c].forEach(o=>{n.value[c][o.fieldname]=!!o.reqd})})},M=()=>{Object.keys(v.data).forEach(c=>{v.data[c].forEach(o=>{n.value[c][o.fieldname]=!1})})};return(c,o)=>(a(),j(xe,{modelValue:T.value,"onUpdate:modelValue":o[1]||(o[1]=k=>T.value=k),options:{title:"Export Data",size:"2xl"}},{"body-content":A(()=>[e("div",Pt,[e("div",zt,[I(pe,{label:"File Type",modelValue:d.value,"onUpdate:modelValue":o[0]||(o[0]=k=>d.value=k),options:["Excel","CSV"],type:"select"},null,8,["modelValue"])]),e("div",Bt,[o[2]||(o[2]=e("p",{class:"mt-2 text-ink-gray-5"}," Select the fields you want to include in the template. ",-1)),e("div",qt,[I(W,{label:"Select All",onClick:F}),I(W,{label:"Select Mandatory Fields",onClick:C}),I(W,{label:"Unselect All",onClick:M})]),e("div",At,[(a(!0),p(Q,null,X(Object.keys(q(v).data),k=>(a(),p("div",{key:k,class:"flex flex-col space-y-2"},[e("div",Jt,D(k),1),e("div",Ht,[(a(!0),p(Q,null,X(q(v).data[k],w=>(a(),p("div",{key:w.fieldname,class:"flex items-center space-x-2"},[I(Ve,{id:`checkbox-${k}-${w.fieldname}`,checked:n.value[k][w.fieldname],onChange:ae=>n.value[k][w.fieldname]=ae.target.checked},null,8,["id","checked","onChange"]),e("label",{for:`checkbox-${k}-${w.fieldname}`,class:G({"text-ink-red-3":w.reqd})},D(w.label||w.fieldname),11,Gt)]))),128))])]))),128))])])])]),actions:A(({close:k})=>[e("div",Wt,[I(W,{label:"Export",variant:"solid",onClick:m}),I(W,{label:"Cancel",onClick:k},null,8,["onClick"])])]),_:1},8,["modelValue"]))}}),Qt={class:"text-base h-full flex flex-col w-[85%] lg:w-[700px] mx-auto pt-12 space-y-8"},Yt={class:"flex flex-col space-y-1 text-ink-gray-7"},Xt={class:"flex items-center justify-between"},Zt={class:"flex items-center space-x-2 text-xl font-semibold text-ink-gray-9"},ea={class:"space-y-4"},ta={key:0,class:"w-4/5 lg:w-2/5 text-center"},aa={key:1,class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2"},sa={class:"space-y-2"},la={class:"font-medium"},oa={class:"text-ink-gray-6"},na={class:"w-full bg-surface-gray-1 h-1 rounded-full mt-3"},ra={key:1,class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},ia={class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2 flex items-center justify-between items-center"},da={class:"space-y-2"},ua={class:"font-medium leading-5"},ca={key:0,class:"text-ink-gray-6"},pa={key:2,class:"flex flex-col h-[300px] p-4 border border-dashed border-outline-gray-3 rounded-md"},ma={class:"flex items-center space-x-2 text-ink-gray-7"},fa={class:"flex-1 flex flex-col items-center justify-center w-[95%] lg:w-[400px] mx-auto space-y-3"},va={class:"flex justify-end"},ya=ee({__name:"UploadStep",props:{dataImports:{},doctype:{},fields:{},data:{}},emits:["updateStep"],setup(h,{emit:T}){const d=T,s=E(null),n=E(""),f=E(!1),u=E(null),v=E(0),N=E(0),R=E(!1),B=E(null),g=E(!0),l=E(!1),m=E(!1),i=fe(),t=h,F=L(()=>N.value===0?0:Math.floor(v.value/N.value*100)),C=b=>{var $,U;const r=($=b.target)==null?void 0:$.files,V=(U=b.dataTransfer)==null?void 0:U.files;return(r==null?void 0:r[0])||(V==null?void 0:V[0])||null},M=b=>{const r=C(b);if(!r)return;if(r.type!=="text/csv"){Z.error("Please upload a valid CSV file."),console.error("Please upload a valid CSV file.");return}u.value=r;const V=new Ne;V.on("start",()=>{f.value=!0}),V.on("progress",$=>{v.value=$.uploaded,N.value=$.total}),V.on("error",$=>{f.value=!1,Z.error($),console.error("File upload error:",$)}),V.on("finish",()=>{f.value=!1}),V.upload(r,{}).then($=>{s.value=$}).catch($=>{console.error("File upload error:",$)})},c=()=>{var b;(b=t.data)!=null&&b.name?k():o()},o=()=>{var b;t.dataImports.insert.submit({reference_doctype:t.doctype,import_type:"Insert New Records",mute_emails:!0,status:"Pending",google_sheets_url:n.value.trim(),import_file:(b=s.value)==null?void 0:b.file_url},{onSuccess(r){i.replace({name:"DataImport",params:{importName:r.name},query:{step:"map"}})},onError(r){var V;Z.error(((V=r.messages)==null?void 0:V[0])||r),console.error("Error creating data import:",r)}})},k=()=>{t.data&&t.dataImports.setValue.submit({...t.data,google_sheets_url:n.value.trim(),import_file:s.value?s.value.file_url:""},{onSuccess(b){le(()=>{s.value||n.value.trim().length?d("updateStep","map",b):d("updateStep","upload",b)})},onError(b){var r;Z.error(((r=b.messages)==null?void 0:r[0])||b,{duration:1e3}),console.error("Error updating data import:",b)}})},w=async b=>{let r=ae(b);const $=await(await fetch(r)).blob(),U=document.createElement("a");U.href=URL.createObjectURL($),U.download=t.doctype+".csv",document.body.appendChild(U),U.click(),document.body.removeChild(U)},ae=b=>{var V,$;if(!t.doctype&&!((V=t.data)!=null&&V.reference_doctype))return"";let r=de(b);return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(t.doctype||(($=t.data)==null?void 0:$.reference_doctype))}
        &export_fields=${encodeURIComponent(JSON.stringify(r))}
        &export_records=blank_template
        &file_type=CSV`.replace(/\s+/g,"")},de=b=>b=="mandatory"?se():y(),se=()=>{var V,$;let r=((V=t.fields.data)==null?void 0:V.docs.find(U=>U.name==t.doctype)).fields.filter(U=>!ne.includes(U.fieldtype)&&U.reqd).map(U=>U.fieldname);return r.unshift("name"),{[t.doctype||(($=t.data)==null?void 0:$.reference_doctype)]:r}},y=()=>{var V;let b={},r=((V=t.fields.data)==null?void 0:V.docs)||[];return r.forEach($=>{var H;let U=$.fields.filter(ue=>!ne.includes(ue.fieldtype)).map(ue=>ue.fieldname);U.unshift("name");let oe=$.name==t.doctype?$.name:he($.name,t.doctype||((H=t.data)==null?void 0:H.reference_doctype),r);b[oe]=U}),b},x=()=>{var b;(b=B.value)==null||b.click()},S=()=>{g.value=!1,m.value=!1,l.value=!0},J=()=>{g.value=!0,m.value=!1,l.value=!1},_=L(()=>!s.value&&!n.value.trim().length);te(()=>t.data,()=>{t.data&&(t.data.import_file?s.value=t.data.import_file:t.data.google_sheets_url&&(S(),n.value=t.data.google_sheets_url))},{immediate:!0}),te([s,n],()=>{(!s.value||!n.value.trim().length)&&k()});const P=()=>{s.value=null},O=b=>(b/1024).toFixed(2)+" KB";return(b,r)=>{var V,$,U,oe;return a(),p("div",Qt,[e("div",Yt,[e("div",Xt,[e("div",Zt,[r[5]||(r[5]=e("span",null," Choose Import ",-1)),(V=h.data)!=null&&V.status?(a(),j(re,{key:0,theme:q(ie)(($=h.data)==null?void 0:$.status)},{default:A(()=>{var H;return[Y(D((H=h.data)==null?void 0:H.status),1)]}),_:1},8,["theme"])):z("",!0)]),I(W,{variant:"solid",onClick:c,disabled:_.value},{default:A(()=>[...r[6]||(r[6]=[Y(" Continue ",-1)])]),_:1},8,["disabled"])]),r[7]||(r[7]=e("div",{class:"leading-5"}," Import data into your system using CSV files or Google Sheets. ",-1))]),e("div",ea,[g.value&&!s.value?(a(),p("div",{key:0,onDragover:r[1]||(r[1]=ye(()=>{},["prevent"])),onDrop:r[2]||(r[2]=ye(H=>M(H),["prevent"])),class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},[g.value&&!f.value?(a(),p("div",ta,[I(K,{name:"upload-cloud",class:"size-6 stroke-1.5 text-ink-gray-6 mx-auto mb-2.5"}),e("input",{ref_key:"fileInput",ref:B,type:"file",accept:".csv",class:"hidden",onChange:r[0]||(r[0]=H=>M(H))},null,544),e("div",{class:"leading-5"},[r[8]||(r[8]=Y(" Drag and drop a CSV file, or upload from your ",-1)),e("span",{onClick:x,class:"cursor-pointer font-semibold hover:underline"},"Device"),r[9]||(r[9]=Y(" or ",-1)),e("span",{onClick:S,class:"cursor-pointer font-semibold hover:underline"}," Google Sheet ")])])):g.value&&f.value?(a(),p("div",aa,[e("div",sa,[e("div",la,D(u.value.name),1),e("div",oa,D(O(v.value))+" of "+D(O(N.value)),1)]),e("div",na,[e("div",{class:"bg-surface-gray-7 h-1 rounded-full transition-all duration-500 ease-in-out",style:me(`width: ${F.value}%`)},null,4)])])):z("",!0)],32)):s.value?(a(),p("div",ra,[e("div",ia,[e("div",da,[e("div",ua,D(s.value.file_name||s.value.split("/").pop()),1),s.value.file_size?(a(),p("div",ca,D(O(s.value.file_size)),1)):z("",!0)]),I(K,{name:"trash-2",class:"size-4 stroke-1.5 text-ink-red-3 cursor-pointer",onClick:P})])])):l.value?(a(),p("div",pa,[e("div",ma,[I(K,{name:"chevron-left",class:"size-4 cursor-pointer",onClick:J}),r[10]||(r[10]=e("div",null," Google Sheet ",-1))]),e("div",fa,[Ee(e("input",{"onUpdate:modelValue":r[3]||(r[3]=H=>n.value=H),type:"text",class:"w-full border border-outline-gray-2 rounded-md px-2.5 text-base",placeholder:"Add Google Sheets Link"},null,512),[[Te,n.value]]),r[11]||(r[11]=e("div",{class:"text-ink-gray-5"}," Make sure the link is publically accessible to fetch the data. ",-1))])])):z("",!0),e("div",va,[I(De,{options:[{label:"Mandatory Fields",onClick(){w("mandatory")}},{label:"All Fields",onClick(){w("all")}},{label:"Custom Template",onClick(){R.value=!0}}]},{default:A(({open:H})=>[I(W,{variant:"ghost"},{prefix:A(()=>[I(K,{name:"download",class:"size-4 stroke-1.5"})]),suffix:A(()=>[I(K,{name:"chevron-down",class:G(["w-4 h-4 stroke-1.5 ml-1 transform transition-transform",H?"rotate-180":""])},null,8,["class"])]),default:A(()=>[r[12]||(r[12]=Y(" Download CSV Template ",-1))]),_:2},1024)]),_:1},8,["options"])])]),t.doctype||(U=t.data)!=null&&U.reference_doctype?(a(),j(Kt,{key:0,modelValue:R.value,"onUpdate:modelValue":r[4]||(r[4]=H=>R.value=H),doctype:t.doctype||((oe=t.data)==null?void 0:oe.reference_doctype)},null,8,["modelValue","doctype"])):z("",!0)])}}}),ga={class:"sticky flex items-center justify-between space-x-28 top-0 z-10 border-b bg-surface-white px-3 py-2.5 sm:px-5"},xa=ee({__name:"DataImport",props:{label:{},description:{},doctype:{},importName:{},doctypeMap:{}},setup(h){const T=be(),d=E("list"),s=E(null),n=h,f=Ue({doctype:"Data Import",fields:["name","reference_doctype","import_type","status","creation","mute_emails","import_file","google_sheets_url","template_options"],auto:!0,orderBy:"modified desc"}),u=_e({url:"frappe.desk.form.load.getdoctype",makeParams:g=>({doctype:g.doctype,with_parent:1}),auto:!1});te(()=>[T.params,n,f.data],()=>{var g,l,m,i,t;(g=f.data)!=null&&g.length&&(n.doctype?(d.value="upload",u.reload({doctype:T.params.doctype})):n.importName&&(v(),!((l=s.value)!=null&&l.import_file)&&!((m=s.value)!=null&&m.google_sheets_url)?d.value="upload":d.value=="upload"&&T.query.step=="map"?d.value=T.query.step:d.value="preview",(i=s.value)!=null&&i.reference_doctype&&u.reload({doctype:(t=s.value)==null?void 0:t.reference_doctype})))},{immediate:!0}),te(()=>T.query,()=>{T.query.step=="list"&&(d.value="list")});const v=()=>{var g;s.value=((g=f.data)==null?void 0:g.find(l=>l.name===n.importName))||null},N=(g,l)=>{d.value=g,l&&(s.value=l)},R=L(()=>{var l,m,i;let g=n.doctype||((l=s.value)==null?void 0:l.reference_doctype);return((i=(m=n.doctypeMap)==null?void 0:m[g||""])==null?void 0:i.title)||g||""}),B=L(()=>{let g=[{label:"Data Import",route:{name:"DataImportList",query:{step:"list"}}}];return d.value!=="list"&&g.push({label:`Importing ${R.value}`}),g});return(g,l)=>{var m;return a(),p(Q,null,[e("header",ga,[I(je,{items:B.value},null,8,["items"]),d.value!="list"?(a(),j(ge,{key:0,class:"flex-1 hidden lg:flex",data:s.value,step:d.value,onUpdateStep:N},null,8,["data","step"])):z("",!0)]),e("div",null,[d.value!="list"?(a(),j(ge,{key:0,class:"flex-1 lg:hidden w-[90%] mx-auto mt-5",data:s.value,step:d.value,onUpdateStep:N},null,8,["data","step"])):z("",!0),d.value==="list"?(a(),j(Xe,{key:1,dataImports:q(f),onUpdateStep:N},null,8,["dataImports"])):d.value==="upload"?(a(),j(ya,{key:2,dataImports:q(f),doctype:h.doctype||((m=s.value)==null?void 0:m.reference_doctype),fields:q(u),data:s.value,onUpdateStep:N},null,8,["dataImports","doctype","fields","data"])):d.value==="map"?(a(),j(it,{key:3,dataImports:q(f),data:s.value,fields:q(u),onUpdateStep:N},null,8,["dataImports","data","fields"])):d.value==="preview"?(a(),j(jt,{key:4,dataImports:q(f),data:s.value,fields:q(u),doctypeMap:h.doctypeMap,onUpdateStep:N},null,8,["dataImports","data","fields","doctypeMap"])):z("",!0)])],64)}}}),ka=ee({__name:"DataImport",setup(h){const{brand:T}=Re(),d=be(),s=fe(),n=Le("$user");ve(()=>{var u;(u=n.data)!=null&&u.is_moderator||s.push({name:"Courses"})});const f={"LMS Course":{title:"Courses",listRoute:"/courses",pageRoute:"/courses/docname"},"LMS Batch":{title:"Batches",listRoute:"/batches"},"LMS Category":{title:"Categories",listRoute:"/lms"}};return Oe(()=>({title:__("Data Import"),icon:T.favicon})),(u,v)=>(a(),j(q(xa),{doctype:q(d).params.doctype,importName:q(d).params.importName,doctypeMap:f},null,8,["doctype","importName"]))}});export{ka as default};
//# sourceMappingURL=DataImport-Chblkl6p.js.map
